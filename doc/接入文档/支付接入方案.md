# 支付接入方案


##支付流程时序图


```sequence
用户->开发者APK:发起支付
开发者APK->BotApkSdk: requireCharge
BotApkSdk->Dueros:
Dueros->小度设备:二维码展现
小度设备->Dueros:手机扫码支付成功
Dueros-->开发者Server:订单状态同步
Note right of Dueros:开发者提供HTTP接口接受支付成功通知
Dueros->BotApkSdk:支付成功
BotApkSdk->开发者APK:onChargeStatusUpdated
开发者APK->用户:业务处理&页面刷新
```

###支付流程简述
开发者调用BotApkSdk.requireCharge发起支付流程，Dueros收到支付请求会在小度设备上展现支付二维码给用户。用户拿手机完成支付，Dueros会往开发者Server发起一个支付成功的HTTP事件请求，开发者接受到请求后，更新库中订单状态。Dueros收到开发者Server返回的成功响应后，会给开发者APK回调onChargeStatusUpdated函数，开发者可在回调中做APK页面刷新。


##接入支付概述

 1. 填写支付成功回调配置
 2. 调用BotApkSdk.requireCharge方法发起支付
 3. 处理HTTP API成功回调
 4. 处理BotApkSdk.onChargeStatusUpdated成功回调

###第一步：填写支付成功回调配置
![图片](https://agroup-bos.cdn.bcebos.com/1376600aa6cf3d3a8d812d439995c0d007f65204)

###第二步：调用BotApkSdk.requireCharge方法发起支付
BotSdk调用示例代码

```java
// 创建金额信息
AmountInfo amountInfo = new AmountInfo();
amountInfo.amount = "0.01";
amountInfo.currencyCode = "CNY";
// 创建订单信息
SellerOrderStructure sellerOrderStructure = new SellerOrderStructure();
sellerOrderStructure.productId = "pid" + System.currentTimeMillis();
sellerOrderStructure.description = "测试商品介绍";
sellerOrderStructure.sellerOrderId = "orderid" + System.currentTimeMillis();
sellerOrderStructure.productName = "测试商品名称";
sellerOrderStructure.sellerNote = "测试商品备注";
// 调用sdk发起支付流程
BotSdk.getInstance().requireCharge(amountInfo, sellerOrderStructure, "测试订单");
```

###第三步：处理HTTP API成功回调
####请求URL
由第三方事先提供，使用HTTPS协议。
####请求方法
GET
####参数
|名称| 格式 | 含义 | 例子 | 
|---|---|---|---|
|sellerOrderId | string | 第三方请求下单时生成的第三方内部订单id | ab502301c2ka| 
|baiduOrderReferenceId | string | 百度内部的订单id，与sellerOrderId唯一关联 | 367446032047198208| 
|sellerAmount | int | 第三方请求扣款的具体金额，币种人民币，单位分 | 1900| 
|payAmount | int | 用户实际支付的具体金额（有可能使用了代金券，所以payAmount <= sellerAmount），币种人民币，单位分 | 1900| 
|payTime | int | 用户付款完成时间，以秒为单位的、10位整数unix时间戳 | 1559318400| 
|requestTime | int | 本次通知请求的生成时间，以秒为单位的、10位整数unix时间戳 | 1559318402| 
|sign | string | 	对上述参数的签名验证结果，采用SHA-256算法 | 7fb0955900263511d9a0941030629e44782601a3ca1ec2c22ba8cea7cfbd57dc|

####返回结果

    {
        "status": 0,
        "msg": "error message"
    }
返回status为0，则通知第三方成功，百度侧不再继续通知；否则，百度侧会重试通知一定次数。

####签名方法
 - 除了sign外的所有参数按照参数名称字母顺序排序后，以 k1=v1&k2=v2&k3=v3… 的方式进行拼接，生成字符串s1；
 - 在s1后附加百度事先分配的签名密钥字符串KEY，生成字符串s2；
 - 计算sign值：signValue = sha256(s2)；
 - 在s1字符串后拼接sign：s1&sign=signValue；
 - 附php签名代码demo
```html/**
 * 生成支付通知的sign
 * $param array 参数字段数组
 * $payCallbackKey string 签名密钥字符串KEY
 * @return string
 */
public function getSign($param, $payCallbackKey) {
    ksort($param);
    $s1 = http_build_query($param);
    $s2 = $s1 . $payCallbackKey;
    $sign = hash('sha256', $s2);
    return $sign;
}
```

####请求样例
GET https://xx.yy.zz/pay/notify?sellerOrderId=ab502301c2ka&baiduOrderReferenceId=367446032047198208&sellerAmount=1900&payAmount=1900&payTime=1559318400&requestTime=1559318402&sign=xxxx


###第四步：BotApkSdk.onChargeStatusUpdated成功回调
BotSdk回调结果处理，示例代码
```java
    /**
     * 支付状态改变的通知
     * @param purchaseResult 支付结果 SUCCESS 支付成功 - ERROR 支付发生错误
     * @param authorizationAmount 应收金额信息
     * @param capturedAmount 实际扣款信息
     * @param creationTimestamp 订单创建时间戳
     * @param baiduOrderReferenceId 此次交易百度生成的订单Id
     * @param sellerOrderId 对应支付的订单ID
     * @param msg 订单信息
     */
    @Override
    public void onChargeStatusUpdated(String purchaseResult, AmountInfo authorizationAmount,
                               AmountInfo capturedAmount, long creationTimestamp,
                               String baiduOrderReferenceId, String sellerOrderId, String msg) {
        String intentResult = getString(R.string.result_intent) + "\n支付状态更新:%s\n订单金额信息：%s\n"
                + "实收金额信息：%s\n订单时间戳：%d\n"
                + "百度侧订单号：%s\n卖方生成的订单号：%s\n订单备注信息：%s";
        mResultIntentTv.setText(String.format(intentResult, purchaseResult, authorizationAmount, capturedAmount,
                creationTimestamp, baiduOrderReferenceId, sellerOrderId, msg));
    }
```

##注意事项

 - 开发者的订单状态，应在HTTP API成功回调接口中更新，且只信任该回调。BotApkSdk.onChargeStatusUpdated的回调仅用在APK前端页面的刷新。

